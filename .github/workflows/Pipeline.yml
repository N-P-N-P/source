name: Salesforce Deployment
on:
  push:
    branches:
      - main  # or your deployment branch
jobs:
  deploy-to-salesforce:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install Salesforce CLI
        run: |
          npm install sfdx-cli --global
      - name: Decrypt server.key
        run: |
          openssl aes-256-cbc -d -in assets/server.key.enc -out server.key -k "${{ secrets.DECRYPT_KEY }}"
      - name: Authenticate with Salesforce
        run: |
          sfdx auth:jwt:grant \
            --clientid ${{ secrets.CONSUMER_KEY }} \
            --jwtkeyfile server.key \
            --username ${{ secrets.SF_USERNAME }} \
            --instanceurl ${{ secrets.SF_LOGIN_URL }} \
            --setalias ci-org
      - name: Push code to Salesforce
        run: |
          sfdx force:source:push -u ci-org
      - name: Run Apex Tests
        run: |
          sfdx force:apex:test:run -u ci-org --resultformat human --wait 10
---
